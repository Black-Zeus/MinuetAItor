# QA: basado en DEV; ajusta ports si deseas cerrar algunos.
# Recomendaci√≥n: mantener tools disponibles para pruebas integradas.
name: ${PROJECT_NAME}

services:
  mariadb:
    image: mariadb:11.4
    container_name: ${PROJECT_NAME}-mariadb
    restart: unless-stopped
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      MARIADB_DATABASE: ${MARIADB_DATABASE}
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
    volumes:
      - ./APP/data/mariadb_data:/var/lib/mysql
      - ./APP/data/settings/mariadb/init:/docker-entrypoint-initdb.d:ro
    ports:
      - "${MARIADB_PORT}:3306"
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "127.0.0.1", "-p${MARIADB_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 20
    labels:
      - "stack=${PROJECT_NAME}"
      - "env=${ENV_NAME}"

  redis:
    image: redis:7-alpine
    container_name: ${PROJECT_NAME}-redis
    restart: unless-stopped
    command: ["redis-server", "/usr/local/etc/redis/redis.conf"]
    volumes:
      - ./APP/data/redis_data:/data
      - ./APP/data/settings/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    ports:
      - "${REDIS_PORT}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 30
    labels:
      - "stack=${PROJECT_NAME}"
      - "env=${ENV_NAME}"

  minio:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    container_name: ${PROJECT_NAME}-minio
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    command: server /data --console-address ":9001"
    volumes:
      - ./APP/data/minio_data:/data
    ports:
      - "${MINIO_PORT}:9000"
      - "${MINIO_CONSOLE_PORT}:9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 30
    labels:
      - "stack=${PROJECT_NAME}"
      - "env=${ENV_NAME}"

  backend:
    build:
      context: .
      dockerfile: ./Data/dokerFile/Dockerfile.backend
    container_name: ${PROJECT_NAME}-backend
    restart: unless-stopped
    environment:
      ENV_NAME: ${ENV_NAME}
      MARIADB_HOST: ${MARIADB_HOST}
      MARIADB_PORT: ${MARIADB_PORT}
      MARIADB_DATABASE: ${MARIADB_DATABASE}
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      MINIO_HOST: ${MINIO_HOST}
      MINIO_PORT: ${MINIO_PORT}
      JWT_SECRET: ${JWT_SECRET}
    volumes:
      - ./APP/volumes/backend/app:/app
      - ./APP/data/backend_data:/app/_data
    ports:
      - "${BACKEND_PORT}:8000"
    depends_on:
      mariadb:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
    labels:
      - "stack=${PROJECT_NAME}"
      - "env=${ENV_NAME}"

  worker:
    build:
      context: .
      dockerfile: ./Data/dokerFile/Dockerfile.worker
    container_name: ${PROJECT_NAME}-worker
    restart: unless-stopped
    environment:
      ENV_NAME: ${ENV_NAME}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
    volumes:
      - ./APP/volumes/worker/app:/app
    depends_on:
      redis:
        condition: service_healthy
    labels:
      - "stack=${PROJECT_NAME}"
      - "env=${ENV_NAME}"

  frontend:
    image: node:20-alpine
    container_name: ${PROJECT_NAME}-frontend
    working_dir: /app
    restart: unless-stopped
    command: sh -c "test -d node_modules || npm install; npm run dev"
    volumes:
      - ./APP/volumes/frontend:/app
      - frontend_node_modules:/app/node_modules
    ports:
      - "${FRONTEND_PORT}:5173"
    environment:
      - NODE_ENV=development
    labels:
      - "stack=${PROJECT_NAME}"
      - "env=${ENV_NAME}"

  # Tools
  adminer:
    image: adminer:4
    container_name: ${PROJECT_NAME}-adminer
    profiles: ["tools"]
    restart: unless-stopped
    ports:
      - "${ADMINER_PORT}:8080"
    environment:
      ADMINER_DEFAULT_SERVER: mariadb
    depends_on:
      mariadb:
        condition: service_healthy
    labels:
      - "stack=${PROJECT_NAME}"
      - "env=${ENV_NAME}"

  redisinsight:
    image: redis/redisinsight:latest
    container_name: ${PROJECT_NAME}-redisinsight
    profiles: ["tools"]
    restart: unless-stopped
    ports:
      - "${REDISINSIGHT_PORT}:5540"
    depends_on:
      redis:
        condition: service_healthy
    labels:
      - "stack=${PROJECT_NAME}"
      - "env=${ENV_NAME}"

  mailpit:
    image: axllent/mailpit:latest
    container_name: ${PROJECT_NAME}-mailpit
    profiles: ["tools"]
    restart: unless-stopped
    ports:
      - "${MAILPIT_UI_PORT}:8025"
      - "${MAILPIT_SMTP_PORT}:1025"
    labels:
      - "stack=${PROJECT_NAME}"
      - "env=${ENV_NAME}"

volumes:
  frontend_node_modules: